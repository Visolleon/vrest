/*
 * vrest 
 * version 0.1.0 
 * 2016-09-27 
 * RESTful AJAX Library 
 * Â© 2016 HappySeven.cn 
 */ 
!function(){var a=window.$$||{},b={};b._config={host:""},a.config=function(a){for(var c in a)b._config[c]=a[c]},b.server={};var c=function(a){var b=new XMLHttpRequest;if(a.url){a.type=a.type||"get",a.type&&"POST"==a.type.toUpperCase()?a.type="POST":a.type&&"UPDATE"==a.type.toUpperCase()?a.type="UPDATE":a.type&&"DELETE"==a.type.toUpperCase()?a.type="DELETE":a.type&&"PUT"==a.type.toUpperCase()?a.type="PUT":a.type="GET",a.async?a.async=!0:a.async=!1,b.timeout=a.timeout,b.ontimeout=function(){a.ontimeout&&a.ontimeout.apply(this,arguments)},b.onerror=a.error,b.onload=function(b){var c=b.currentTarget;200==c.status?a.success&&a.success(JSON.parse(c.response)):a.error&&a.error(c),a.complete&&a.complete()},a.beforeSend&&a.beforeSend();var c=[];for(var d in a.data)c.push([d,a.data[d]].join("="));"GET"==a.type&&(a.url.indexOf("?")>-1?a.url+="&"+c.join("&"):a.url+="?"+c.join("&")),b.open(a.type,a.url),a.headers={},a.headers["Content-Type"]||("json"==a.dataType?a.headers["Content-Type"]="application/x-www-form-urlencoded":a.headers["Content-Type"]="text/plain"),a.headers.Accept="application/json, text/javascript, */*",a.crossDomain||a.headers["X-Requested-With"]||(a.headers["X-Requested-With"]="XMLHttpRequest");for(var d in a.headers)b.setRequestHeader(d,a.headers[d]);if(a.xhrFields)for(var e in a.xhrFields)b[e]=a.xhrFields[e];"GET"==a.type?b.send():b.send(c.join("&"))}};b.server.onerror=null,b.server.ajax=function(a){c({url:[b._config.host,"/",a.path].join(""),data:a.data,dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,type:a.type||"GET",success:function(){a.success&&a.success.apply(this,arguments)},error:function(){a.error&&a.error.apply(this,arguments),b.server.onerror&&b.server.onerror.apply(this,arguments)},complete:function(){a.complete&&a.complete.apply(this,arguments)}})},b.server.get=function(a,c,d,e,f){var g={path:a,type:"GET",data:c,success:d,error:e,complete:f};b.server.ajax(g)},b.server.post=function(a,c,d,e,f){var g={path:a,type:"POST",data:c,success:d,error:e,complete:f};b.server.ajax(g)},b.server.send=function(a,c,d,e,f,g){var h={path:a,type:c,data:d,success:e,error:f,complete:g};b.server.ajax(h)},a._config=b,window.$$=window.vRest=a}(),function(){var a=window.$$||{},b=a._config,c=function(a){var d=this;return this._op={},this.meta=a,this.meta._cacheData=this.meta._cacheData||{},this.exec=function(a){var e=arguments,f={},g=d.meta||{};if(a&&a.constructor==Object)f=a;else{var h=0;for(var i in g.params){if(f[i]=e[h],void 0==e[h]||null==e[h])f[i]=g.params[i].default;else if("int"==g.params[i].type){var j=parseInt(e[h]);NaN==j&&console.warn("param",i,"is not integer.")}h++}}var k=this.method;k||(k=g.methods&&g.methods.length>0?g.methods[0]:"GET");var l=g.url||"",m=JSON.stringify(f),n=null;return g.check?n=g.check.apply(f,null):g.cache&&(n=d.meta._cacheData[m],n&&g.run&&(n=g.run.call(d,n))),"boolean"!=typeof n||n?n instanceof Object?(d._op.ok||d._op.success?(d._op.before&&d._op.before.apply(f,null),d._op.ok&&d._op.ok.call(d,n),d._op.success&&d._op.success.call(d,{return:n,status:1}),d._op.complete&&d._op.complete()):setTimeout(function(){d._op.before&&d._op.before.apply(f,null),d._op.ok&&d._op.ok.call(d,n),d._op.success&&d._op.success.call(d,{return:n,status:1}),d._op.complete&&d._op.complete()},0),d):(l=l.split("/").map(function(a){if(":"==a[0]){var b=a.slice(1),c=f[b];if(c)return delete f[b],c}return a}).join("/"),setTimeout(function(){d._op.before&&d._op.before.apply(f,null),b.server.send(l,k,f,function(a){d._op.success&&d._op.success.call(d,a);var b=a;if(g.cache&&(d.meta._cacheData[m]=a,g.timeout)){var e=parseInt(g.timeout)||3e5;setTimeout(function(){var a=new c(g);a.clear();var b=[];if(g.autoUpdate){for(var e in f)b.push(f[e]);a.exec.apply(d,b)}},e)}g.run&&(b=g.run.call(d,a)),d._op.ok&&d._op.ok.call(d,b)},function(a){d._op.error&&d._op.error(a.status,a.responseJSON)},function(){d._op.complete&&d._op.complete()})},0),d):d},this.clear=function(){return this.meta._cacheData={},this},this.before=function(a){return this._op.before=a,this},this.success=function(a){return this._op.success=a,this},this.ok=function(a){return this._op.ok=a,this},this.error=function(a){return this._op.error=a,this},this.complete=this.end=function(a){return this._op.complete=a,this},this},d=function(a,b,d){Object.defineProperty(a,b,{get:function(){var a=new c(d),b=function(){return a.method=null,this.exec.apply(this,arguments)}.bind(a);b.clear=function(){return a.meta._cacheData={},a},b.before=a.before.bind(a),b.ok=a.ok.bind(a),b.complete=a.complete.bind(a),b.error=a.error.bind(a),d.methods=d.methods||["GET"];for(var e=0;e<d.methods.length;e++){var f=d.methods[e];f&&(f=f.toLocaleLowerCase(),function(c){b[c]=function(){return a.method=c,this.exec.apply(this,arguments)}.bind(a)}(f))}return b},set:function(){console.error("redefine function:",b)}})};a.register=function(b){for(var c in b)a[c]?console.warn("duplicate meta register:",c):b[c]instanceof Function?a[c]=b[c]:d(a,c,b[c])},a.url={queryString:document.location.search,query:function(a){return decodeURIComponent((this.queryString.match(new RegExp("(?:^\\?|&)"+a+"=(.*?)(?=&|$)"))||["",""])[1])}},a.cache={storage:window.localStorage,set:function(a,b){var c=b;if("string"!=typeof c&&(c=JSON.stringify(b)),this.storage)this.storage.setItem(a,c);else{var d=new Date;d.setDate(d.getDate()+30),document.cookie=a+"="+escape(c)+";expires="+d.toGMTString()}},remove:function(a){if(this.storage)this.storage.removeItem(a);else{var b=new Date;b.setDate(b.getDate()-1),document.cookie=a+"=1;expires="+b.toGMTString()+";path=/"}},get:function(a){var b="";if(this.storage)b=this.storage.getItem(a);else if(document.cookie.length>0){var c=document.cookie.indexOf(a+"=");if(c!=-1){c=c+a.length+1;var d=document.cookie.indexOf(";",c);d==-1&&(d=document.cookie.length),b=unescape(document.cookie.substring(c,d))}}if(b)try{return JSON.parse(b)}catch(a){}return b}},window.$$=window.vRest=a}();