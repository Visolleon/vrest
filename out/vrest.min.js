/*
 * vrest 
 * version 0.1.0 
 * 2018-08-13 
 * RESTful AJAX Library 
 * Â© 2018 HappySeven.cn 
 */ 
!function(a){var b=a.$$||{},c={};c._config={host:"",crossDomain:!0,data:[]},b.config=function(a){for(var b in a)c._config[b]=a[b]},c.server={};var d=function(a){if(!a.url)return void console.error("url is invalid.");if(a.type=a.type||"get",a.type&&"POST"==a.type.toUpperCase()?a.type="POST":a.type&&"UPDATE"==a.type.toUpperCase()?a.type="UPDATE":a.type&&"DELETE"==a.type.toUpperCase()?a.type="DELETE":a.type&&"PUT"==a.type.toUpperCase()?a.type="PUT":a.type="GET",a.beforeSend&&a.beforeSend(),a.dataType=(a.dataType||"").toLowerCase(),a.headers={},a.headers["Content-Type"]||("json"==a.dataType?a.headers["Content-Type"]="application/x-www-form-urlencoded":a.headers["Content-Type"]="text/plain"),a.headers.Accept="application/json, text/javascript, */*",a.crossDomain||a.headers["X-Requested-With"]||(a.headers["X-Requested-With"]="XMLHttpRequest"),wx&&wx.request){if(c._config.data)for(var b in c._config.data){var d=c._config.data[b];a.data[b]="function"==typeof d?d():d}wx.request({url:a.url,data:a.data,method:a.type,dataType:a.dataType,header:a.headers,success:function(b){a.success&&a.success(b.data)},fail:a.error,complete:a.complete})}else{var e=new XMLHttpRequest;a.async?a.async=!0:a.async=!1,e.timeout=a.timeout,e.ontimeout=function(){a.ontimeout&&a.ontimeout.apply(this,arguments)},e.onerror=a.error,e.onload=function(b){var c=b.currentTarget;if(200==c.status)if("json"==a.dataType){var d=JSON.parse(c.response);a.success&&a.success(d)}else a.success&&a.success(c.response);else a.error&&a.error(c,a);a.complete&&a.complete()};var f=[];for(var b in a.data)f.push([b,a.data[b]].join("="));if(c._config.data)for(var b in c._config.data){var d=c._config.data[b];"function"==typeof d?f.push([b,d()].join("=")):f.push([b,d].join("="))}"GET"==a.type&&(a.url.indexOf("?")>-1?a.url+="&"+f.join("&"):a.url+="?"+f.join("&")),e.open(a.type,a.url);for(var b in a.headers)e.setRequestHeader(b,a.headers[b]);if(a.xhrFields)for(var g in a.xhrFields)e[g]=a.xhrFields[g];"GET"==a.type?e.send():e.send(f.join("&"))}};c.server.onerror=null,c.server.ajax=function(a){var b={url:[c._config.host,"/",a.path].join(""),data:a.data,dataType:a.dataType||"json",type:a.type||"GET",success:function(){a.success&&a.success.apply(this,arguments)},error:function(){a.error&&a.error.apply(this,arguments),c.server.onerror&&c.server.onerror.apply(this,arguments)},complete:function(){a.complete&&a.complete.apply(this,arguments)}};c._configcrossDomain&&(b.xhrFields={withCredentials:!0},b.crossDomain=!0),d(b)},c.server.get=function(a,b,d,e,f){var g={path:a,type:"GET",data:b,success:d,error:e,complete:f};c.server.ajax(g)},c.server.post=function(a,b,d,e,f){var g={path:a,type:"POST",data:b,success:d,error:e,complete:f};c.server.ajax(g)},c.server.send=function(a,b,d,e,f,g){var h={path:a,type:b,data:d,success:e,error:f,complete:g};c.server.ajax(h)},b._config=c,a.$$=a.vRest=b}(window),function(a){var b=a.$$||{},c=b._config,d=function(a){var b=this;return this._op={},this.meta=a,this.meta._cacheData=this.meta._cacheData||{},this.exec=function(a){var e=arguments,f={},g=b.meta||{};if(a&&a.constructor==Object)f=a;else{var h=0;for(var i in g.params){if(f[i]=e[h],void 0==e[h]||null==e[h])f[i]=g.params[i].default;else if("int"==g.params[i].type){var j=parseInt(e[h]);NaN==j&&console.warn("param",i,"is not integer.")}h++}}var k=this.method;k||(k=g.methods&&g.methods.length>0?g.methods[0]:"GET");var l=g.url||"",m=JSON.stringify(f),n=null;return g.check?n=g.check.apply(f,null):g.cache&&(n=b.meta._cacheData[m])&&g.run&&(n=g.run.call(b,n)),"boolean"!=typeof n||n?n instanceof Object?(b._op.ok||b._op.success?(b._op.before&&b._op.before.apply(f,null),b._op.ok&&b._op.ok.call(b,n),b._op.success&&b._op.success.call(b,{return:n,status:1}),b._op.complete&&b._op.complete()):setTimeout(function(){b._op.before&&b._op.before.apply(f,null),b._op.ok&&b._op.ok.call(b,n),b._op.success&&b._op.success.call(b,{return:n,status:1}),b._op.complete&&b._op.complete()},0),b):(l=l.split("/").map(function(a){if(":"==a[0]){var b=a.slice(1),c=f[b];if(c)return delete f[b],c}return a}).join("/"),setTimeout(function(){b._op.before&&b._op.before.apply(f,null),c.server.ajax({path:l,type:k,data:f,success:function(a){b._op.success&&b._op.success.call(b,a);var c=a;if(g.cache&&(b.meta._cacheData[m]=a,g.timeout)){var e=parseInt(g.timeout)||3e5;setTimeout(function(){var a=new d(g);a.clear();var c=[];if(g.autoUpdate){for(var e in f)c.push(f[e]);a.exec.apply(b,c)}},e)}g.run&&(c=g.run.call(b,a)),b._op.ok&&b._op.ok.call(b,c)},error:function(a){b._op.error&&b._op.error(a.status,a.responseJSON,f)},complete:function(){b._op.complete&&b._op.complete()}})},0),b):b},this.clear=function(){return this.meta._cacheData={},this},this.before=function(a){return this._op.before=a,this},this.success=function(a){return this._op.success=a,this},this.ok=function(a){return this._op.ok=a,this},this.error=function(a){return this._op.error=a,this},this.complete=this.end=function(a){return this._op.complete=a,this},this},e=function(a,b,c){Object.defineProperty(a,b,{get:function(){var a=new d(c),b=function(){return a.method=null,this.exec.apply(this,arguments)}.bind(a);b.clear=function(){return a.meta._cacheData={},a},b.before=a.before.bind(a),b.ok=a.ok.bind(a),b.complete=a.complete.bind(a),b.error=a.error.bind(a),c.methods=c.methods||["GET"];for(var e=0;e<c.methods.length;e++){var f=c.methods[e];f&&(f=f.toLocaleLowerCase(),function(c){b[c]=function(){return a.method=c,this.exec.apply(this,arguments)}.bind(a)}(f))}return b},set:function(){console.error("redefine function:",b)}})};b.register=function(a){for(var c in a)b[c]?console.warn("duplicate meta register:",c):a[c]instanceof Function?b[c]=a[c]:e(b,c,a[c])},b.registerSingle=function(a,c){b[a]?console.warn("duplicate meta register:",a):e(b,a,c)},b.url={queryString:document.location.search,query:function(a){return decodeURIComponent((this.queryString.match(new RegExp("(?:^\\?|&)"+a+"=(.*?)(?=&|$)"))||["",""])[1])}},b.cache={storage:a.localStorage,set:function(a,b){var c=b;if("string"!=typeof c&&(c=JSON.stringify(b)),this.storage)this.storage.setItem(a,c);else{var d=new Date;d.setDate(d.getDate()+30),document.cookie=a+"="+escape(c)+";expires="+d.toGMTString()}},remove:function(a){if(this.storage)this.storage.removeItem(a);else{var b=new Date;b.setDate(b.getDate()-1),document.cookie=a+"=1;expires="+b.toGMTString()+";path=/"}},get:function(a){var b="";if(this.storage)b=this.storage.getItem(a);else if(document.cookie.length>0){var c=document.cookie.indexOf(a+"=");if(-1!=c){c=c+a.length+1;var d=document.cookie.indexOf(";",c);-1==d&&(d=document.cookie.length),b=unescape(document.cookie.substring(c,d))}}if(b)try{return JSON.parse(b)}catch(c){console.warn("cache data is not json:",a,b)}return b}},a.$$=a.vRest=b}(window);